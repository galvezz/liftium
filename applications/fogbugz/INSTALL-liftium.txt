### followed instructions from: http://www.fogcreek.com/FogBugz/docs/60/topics/setup/UnixSystemRequirements.html
### and: http://chris-lamb.co.uk/2009/04/11/installing-fogbugz-debian-way/

### prep the box with prereqs (from: http://www.fogcreek.com/FogBugz/docs/70/topics/setup/UnixGettingYourServerRead.html#deb)

# 'mono' got split up, so we install mono-runtime instead
$ apt-get install mono-runtime mono-gmcs

# then the list straight from the webpage, minus mono
$ apt-get install apache2 mysql-server-5.0 libapache2-mod-php5 php5-cli php5-imap php5-mysql curl libstdc++5 php-pear libmono2.0-cil php5-curl

# some deps can be installed via pear, but there's debian equivalents:
$ apt-get install php-auth php-mail-mime php-http-request php-mail php-db 

# some php deps aren't on the system, we'll install the deb build tools for them
$ apt-get install dh-make-php dpkg-dev fakeroot build-essential 

# liftium's php.ini script disables the system wide include dir, so we have to temporarily enable this:
$ vi /etc/php5/conf.d/liftium.ini 
; temporary addition to make 'dh-make-pear' & co work
include_path = .:/usr/share/php/;

# now install the pear packages as debs (see below for the pear2deb shell script)
$ sh /tmp/pear2deb.sh

# and change the include path settings back:
$ vi /etc/php5/conf.d/liftium.ini 

### skipped 'eaccellerator' installation -- runs 'ok' for us on creative.ly without it.

### mono-gmcs installs /bin/gmcs2, but fogbugz expects /bin/gmcs in the path
$ ln -s /usr/bin/gmcs2 /usr/local/bin/gmcs

$ cd /tmp; tar -zxvf fogbugz-setup-php-latest.tgz; cd fogbugz;

### change the install path from /opt/fogbugz to:
$ vi install.sh
INSTALL_DIR="/usr/local/fogbugz"

### 'no' for apahce config, 'yes' for php config
$ sudo ./install.sh

# enable ssl -- FIREWALL will need to be opened for this if desired.
$ /etc/apache2/mods-enabled
$ ln -s ../mods-available/ssl.conf 
$ ln -s ../mods-available/ssl.load

# set up the virtual host (see below for the code)
$ vi /etc/apache2/sites-enabled/fogbugz.liftium.com.conf

# remove the /fogbugz alias from the installed version, it overlaps with our own at /
$ vi /usr/local/fogbugz/Accessories/fogbugz.conf
#Alias /fogbugz "/usr/local/fogbugz/Website"


# fogbugz added 5 lines to php.ini, we'll move those to it's own file
# make sure it's zz_fogbugz.ini so its settings are not overridden.
# most ***IMPORTANT*** is the include path
# XXX this should probably be done by vhost instead.
# see below for the lines from this install
$ vi /etc/php5/apache2/php.ini
(copy & remove last 5 lines or so; everything after the added by fogbugz marker)

$ vi /etc/php5/conf.d/zz_fogbugz.ini
(paste the 5 or so lines in here)
include_path = .:/usr/share/php;


# restart apache:
$ sudo /etc/init.d/apache2 restart

# fogbugz likes to send bigger messages to mysql, and requests for max_allowed_packet = 50M
$ sudo echo "[mysqld]\nmax_allowed_packet = 50M"  > /etc/mysql/conf.d/fogbugz.cnf
$ sudo /etc/init.d/mysql restart

# time to setup fogbugz. If you dont have a mysql admin setup up yet, use this:
$ echo "CREATE USER 'tmpadmin'@'%' IDENTIFIED BY 'tmppw';" | sudo mysql
$ echo "GRANT ALL ON *.* TO 'tmpadmin'@'%' WITH GRANT OPTION;" | sudo mysql
$ echo "flush privileges" | sudo mysql

# then open the web setup and follow the instructions:

http://yourhost.tld/install1.php

# clean up the temp user if need be:
$ echo "DROP user tmpadmin" | sudo mysql


__END__

### files are in this directory, but for quick overview:

pear2deb.sh:
#!/bin/sh
set -e
for PEAR_PKG in Auth_SASL HTTP_Client Mail_Mime XML_Tree
do
        PKG_TEMP=$(mktemp -d)
        cd ${PKG_TEMP}
        pear download ${PEAR_PKG}
        dh-make-pear ${PEAR_PKG}*.tgz
        cd $(find -mindepth 1 -type d | head -n1)
        dpkg-buildpackage -uc -us -rfakeroot
        sudo dpkg -i ../*.deb
        rm -rf ${PKG_TEMP}
done

fogbugz.liftium.com.conf:
<VirtualHost *>
    ServerName fogbugz.liftium.com
    ServerAdmin fogbugz-admin@liftium.com
    DocumentRoot "/var/www"

    Alias / "/usr/local/fogbugz/Website/"
    Include "/usr/local/fogbugz/Accessories/fogbugz.conf"

    ErrorLog /var/log/apache2/error.log
    LogLevel warn
    CustomLog /var/log/apache2/access.log combined

    SSLEngine on
    SSLCertificateFile    /etc/ssl/certs/ssl-cert-snakeoil.pem
    SSLCertificateKeyFile /etc/ssl/private/ssl-cert-snakeoil.key
    BrowserMatch ".*MSIE.*" \
        nokeepalive ssl-unclean-shutdown \
        downgrade-1.0 force-response-1.0
</VirtualHost>

fogbugz.ini:
; Automatically added by FogBugz
extension=fogutil.so
error_reporting = E_ALL & ~E_NOTICE
display_errors = Off
memory_limit = 256M

